<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CoinBear — Dashboard</title>

  <link rel="stylesheet" href="public/styles/reset.css" />
  <link rel="stylesheet" href="public/styles/tokens.css" />
  <link rel="stylesheet" href="public/styles/page.css" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Inter:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

  <script type="module">
    import { define, Auth } from "@calpoly/mustang";
    define({ "mu-auth": Auth.Provider });
  </script>

  <style>
    .user-menu { position: relative; display: inline-block; }
    .user-menu .menu-panel {
      position: absolute; right: 0; top: calc(100% + 8px);
      display: none; min-width: 160px; padding: 8px 0;
      border-radius: 10px;
      background: var(--surface-2, #1f2330); /* dark-mode safe */
      color: var(--color-text, #fff);
      box-shadow: 0 8px 20px rgba(0,0,0,0.4); z-index: 20;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .user-menu .menu-panel.open { display: block; }
    .user-menu .menu-panel a {
      display: block; padding: 10px 14px; border-radius: 6px;
      text-decoration: none; color: var(--color-text, #fff);
      transition: background 0.2s ease;
    }
    .user-menu .menu-panel a:hover { background: rgba(255,255,255,0.1); }
    #user-toggle[disabled] { opacity: .6; cursor: default; }
  </style>
</head>
<body>
  <!-- Provide auth to the whole page -->
  <mu-auth provides="blazing:auth">
    <!-- Header -->
    <header class="app-header">
      <div class="app-left">
        <img src="public/images/coinbear.png" alt="CoinBear" class="logo" />
        <div class="titles">
          <h1 class="app-name">CoinBear</h1>
          <div class="page-name">Dashboard</div>
        </div>
      </div>

      <nav class="app-nav" aria-label="Primary">
        <a href="/budget.html" class="btn-icon" aria-current="page">
          <svg class="icon"><use href="public/icons/icons.svg#icon-budget"></use></svg>
          Budget
        </a>
        <a href="./category.html" class="btn-icon">
          <svg class="icon"><use href="public/icons/icons.svg#icon-categories"></use></svg>
          Categories
        </a>
        <a href="./goal.html" class="btn-icon">
          <svg class="icon"><use href="public/icons/icons.svg#icon-savings"></use></svg>
          Goals
        </a>
        <a href="./merchants.html" class="btn-icon">
          <svg class="icon"><use href="public/icons/icons.svg#icon-transactions"></use></svg>
          Merchants
        </a>
      </nav>

      <div class="app-user">
        <div class="user-menu">
          <button id="user-toggle" class="btn btn-soft">
            Hi, <span id="user-name">traveler</span> ▾
          </button>
          <div id="user-menu-panel" class="menu-panel">
            <a id="logout-item" href="#">Logout</a>
          </div>
        </div>

        <label id="theme-toggle" class="row" style="gap:6px;cursor:pointer;align-items:center;margin-left:12px;">
          <input id="darkmode-input" type="checkbox" autocomplete="off" />
          Dark mode
        </label>
      </div>
    </header>

    <main class="container">
      <!-- Sidebar -->
      <aside class="sidebar card">
        <img src="public/images/coinbear.png" alt="CoinBear" class="logo logo-large" />
        <div class="quickadd-wrap">
          <details class="quickadd">
            <summary class="btn btn-accent">＋ Quick Add</summary>
            <div class="menu">
              <a href="./goal.html">New Goal</a>
              <a href="./transaction.html">New Income</a>
              <a href="./transaction.html">New Expense</a>
            </div>
          </details>
        </div>

        <ul class="navlist">
          <li>
            <a href="./account.html">
              <svg class="icon"><use href="public/icons/icons.svg#icon-account2"></use></svg>
              Account
            </a>
          </li>
          <li>
            <a href="./transaction.html">
              <svg class="icon"><use href="public/icons/icons.svg#icon-account"></use></svg>
              New Transaction
            </a>
          </li>
        </ul>

        <section class="card">
          <h3>★ Goal</h3>
          <figure class="goal">
            <img src="public/images/ipad.jpg" alt="" class="goal-img" />
            <figcaption>
              <strong>iPad Air 6th Gen</strong>
              <div class="muted">$500.00</div>
              <progress value="2" max="100"></progress>
              <div class="muted">2%</div>
            </figcaption>
          </figure>
        </section>
      </aside>

      <!-- Main dashboard content -->
      <section class="grid stretch">
        <div class="card kpi col-4 md-col-6 sm-full"> 
          <div class="muted">Total income (this month)</div>
          <div id="total-income" class="kpi-value">$3,200</div>
          <div class="hint">Month-to-date totals based on manual accounts</div>
        </div>
        <div class="card kpi col-4 md-col-6 sm-full"> 
          <div class="muted">Total expenses (this month)</div>
          <div id="total-expenses" class="kpi-value">$2,850</div>
          <div class="hint">Month-to-date totals based on manual accounts</div>
        </div>
        <div class="card kpi col-4 md-col-6 sm-full"> 
          <div class="muted">Balance (this month)</div>
          <div id="total-balance" class="kpi-value">$350</div>
          <div class="hint">income − expenses</div>
        </div>

        <section class="card col-12">
          <header class="row">
            <h2>Expenses by Category</h2>
            <a class="btn btn-soft" href="./category.html">＋ New Category</a>
          </header>
          <ul id="category-list" class="chip-list">
            <li class="chip">Groceries <strong>$350</strong></li>
            <li class="chip">Bills <strong>$420</strong></li>
            <li class="chip">Personal <strong>$180</strong></li>
            <li class="chip">Medical <strong>$95</strong></li>
          </ul>
        </section>

        <section class="card col-12">
          <header class="row">
            <h2>Wishlist</h2>
            <a class="btn btn-soft" href="./goal.html">＋ New Wish</a>
          </header>
          <ul class="chip-list">
            <li class="chip chip-soft">Weekend Trip <strong>$300</strong></li>
            <li class="chip chip-soft">iPad Case <strong>$45</strong></li>
          </ul>
        </section>
      </section>
    </main>
  </mu-auth>

  <!-- theme logic -->
  <script type="module" src="public/scripts/theme.js"></script>

  <!-- Auth dropdown + username updater -->
  <script type="module">
    import { Observer, Auth } from "@calpoly/mustang";

    const mu = document.querySelector("mu-auth");
    const nameEl = document.getElementById("user-name");
    const toggleBtn = document.getElementById("user-toggle");
    const menuPanel = document.getElementById("user-menu-panel");
    const logoutItem = document.getElementById("logout-item");

    const decodeJwt = (token) => {
      try {
        const base64 = token.split(".")[1];
        const json = atob(base64.replace(/-/g, "+").replace(/_/g, "/"));
        return JSON.parse(json);
      } catch { return {}; }
    };

    const findUsernameFallback = () => {
      const candidates = ["mu:auth", "auth", "token"];
      for (const k of candidates) {
        const v = localStorage.getItem(k);
        if (!v) continue;
        try {
          const parsed = JSON.parse(v);
          const token = parsed?.user?.token || parsed?.token || parsed?.jwt;
          if (parsed?.user?.username) return parsed.user.username;
          if (token) return decodeJwt(token)?.username;
        } catch {
          const u = decodeJwt(v)?.username;
          if (u) return u;
        }
      }

      for (let i = 0; i < localStorage.length; i++) {
        const val = localStorage.getItem(localStorage.key(i));
        if (val && val.split(".").length === 3) {
          const u = decodeJwt(val)?.username;
          if (u) return u;
        }
      }
      return undefined;
    };

    const setName = (username) => {
      nameEl.textContent = username || "traveler";
    };

    const bootUser = findUsernameFallback();
    if (bootUser) setName(bootUser);

    const observer = new Observer(document.body, "blazing:auth");
    observer.observe((auth /** @type {Auth.Model} */) => {
      const { user } = auth;
      if (user?.authenticated) {
        setName(user.username);
      } else {
        setName(bootUser || "traveler");
        menuPanel.classList.remove("open");
      }
    });

    toggleBtn.addEventListener("click", (e) => {
      e.preventDefault();
      menuPanel.classList.toggle("open");
    });
    document.addEventListener("click", (e) => {
      if (!menuPanel.contains(e.target) && !toggleBtn.contains(e.target)) {
        menuPanel.classList.remove("open");
      }
    });

    logoutItem.addEventListener("click", (e) => {
      e.preventDefault();
      mu?.dispatchEvent(
        new CustomEvent("auth:message", {
          bubbles: true,
          composed: true,
          detail: ["auth/signout"]
        })
      );
      window.location.href = "/login.html";
    });
  </script>
</body>
</html>
